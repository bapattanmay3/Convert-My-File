{% extends "base.html" %}
{% block content %}
<div class="translator-container">
    <div class="translator-main">
        <h1>üåç Translator</h1>
        <p class="tagline">High-Fidelity Document Translation across 100+ Languages</p>

        <div class="converter-card" id="translator-card">
            <div id="upload-section">
                <div class="upload-area" id="file-drop-area">
                    <span class="upload-icon">üìÑ</span>
                    <div class="btn-premium" style="padding: 10px 25px; margin-bottom: 10px;" id="browse-btn">Select
                        Document</div>
                    <p style="color: var(--text-muted);">PDF, DOCX, XLSX, XLS, CSV or TXT</p>
                    <input id="file-upload" name="file" type="file" accept=".pdf,.docx,.txt,.xlsx,.xls,.csv"
                        onchange="handleFileSelect(this)" hidden />
                </div>

                <div id="file-info" class="file-info" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">üìÑ</span>
                            <div style="display: flex; flex-direction: column;">
                                <span id="display-name" style="font-weight: 600;"></span>
                                <span id="display-size" style="color: var(--text-muted); font-size: 0.85rem;"></span>
                            </div>
                        </div>
                        <button type="button" id="remove-file" class="btn-icon">‚úñ</button>
                    </div>
                </div>

                <div id="translate-options" style="display: none; margin-top: 30px; text-align: left;">
                    <div class="option-group">
                        <label style="color: var(--text-muted); font-size: 0.9rem; font-weight: 500;">Target
                            Language</label>
                        <select id="target-lang" class="form-select">
                            {% for code, name in languages.items() %}
                            <option value="{{ code }}" {% if code=='en' %}selected{% endif %}>{{ name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <button type="button" id="translate-btn" class="btn-premium" style="width: 100%; margin-top: 30px;">
                        <span>üöÄ Translate Now</span>
                    </button>
                </div>
            </div>

            <!-- Processing State -->
            <div id="status-msg" style="margin-top: 20px; display: none; text-align: center;">
                <div style="color: var(--primary); font-size: 1.2rem; margin-bottom: 10px;">
                    <span class="loading-dots">Translating your document</span>
                </div>
                <p style="color: var(--text-muted); font-size: 0.9rem;">This may take a moment for larger files...</p>
            </div>

            <!-- Result Area -->
            <div id="result-area"
                style="display: none; margin-top: 30px; padding: 25px; background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 20px; text-align: center;">
                <h3 style="color: #10b981; margin-bottom: 20px;">‚úÖ Translation Complete!</h3>
                <div style="display: flex; gap: 15px; justify-content: center; flex-direction: column;">
                    <button id="preview-btn" class="btn-premium"
                        style="background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); box-shadow: none;">
                        üëÅÔ∏è Preview Translated Text
                    </button>
                    <a id="download-link" href="#" class="btn-premium">
                        ‚¨áÔ∏è Download Translated File
                    </a>
                </div>
            </div>

            <div id="error-msg"
                style="display: none; margin-top: 20px; padding: 15px; border-radius: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); color: #ef4444; text-align: center;">
            </div>
        </div>
    </div>

    <!-- SIDE PREVIEW PANE -->
    <div id="preview-pane" class="preview-pane" style="display: none;">
        <div class="preview-header">
            <h3>üëÅÔ∏è Translation Preview</h3>
            <span style="font-size: 0.8rem; color: var(--text-muted);">First 10,000 characters</span>
        </div>
        <div class="preview-content">
            <pre id="preview-text-area"></pre>
        </div>
    </div>
</div>

<style>
    .translator-container {
        display: flex;
        gap: 30px;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 800px;
        margin: 0 auto;
    }

    .translator-main {
        flex: 1;
        min-width: 0;
    }

    .preview-pane {
        flex: 1;
        background: var(--card-bg);
        border: 1px solid var(--glass-border);
        border-radius: 24px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        animation: slideIn 0.5s ease;
        max-height: 700px;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .preview-header {
        padding: 20px;
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .preview-header h3 {
        margin: 0;
        color: var(--primary);
        font-size: 1.2rem;
    }

    .preview-content {
        padding: 20px;
        overflow-y: auto;
        background: #080808;
    }

    #preview-text-area {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 0.9rem;
        line-height: 1.6;
        color: #f1f5f9;
        margin: 0;
        text-align: left;
    }

    .loading-dots:after {
        content: '.';
        animation: dots 1.5s steps(5, end) infinite;
    }

    @keyframes dots {

        0%,
        20% {
            content: '.';
        }

        40% {
            content: '..';
        }

        60% {
            content: '...';
        }

        80%,
        100% {
            content: '';
        }
    }

    /* Adjust container when preview is active */
    .has-preview {
        max-width: 1300px;
    }

    @media (max-width: 1000px) {
        .translator-container.has-preview {
            flex-direction: column;
        }

        .preview-pane {
            max-height: 400px;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileUpload = document.getElementById('file-upload');
        const dropArea = document.getElementById('file-drop-area');
        const browseBtn = document.getElementById('browse-btn');
        const fileInfo = document.getElementById('file-info');
        const displayName = document.getElementById('display-name');
        const displaySize = document.getElementById('display-size');
        const removeFile = document.getElementById('remove-file');
        const translateOptions = document.getElementById('translate-options');
        const translateBtn = document.getElementById('translate-btn');
        const statusMsg = document.getElementById('status-msg');
        const resultArea = document.getElementById('result-area');
        const downloadLink = document.getElementById('download-link');
        const previewBtn = document.getElementById('preview-btn');
        const errorMsg = document.getElementById('error-msg');
        const targetLang = document.getElementById('target-lang');

        // Preview pane elements
        const container = document.querySelector('.translator-container');
        const previewPane = document.getElementById('preview-pane');
        const previewTextArea = document.getElementById('preview-text-area');

        let selectedFile = null;
        let lastResultFilename = null;

        browseBtn.onclick = () => fileUpload.click();
        dropArea.onclick = (e) => { if (e.target !== browseBtn) fileUpload.click(); };

        fileUpload.onchange = (e) => {
            if (e.target.files && e.target.files[0]) {
                selectedFile = e.target.files[0];
                displayName.textContent = selectedFile.name;
                displaySize.textContent = (selectedFile.size / 1024).toFixed(1) + ' KB';

                dropArea.style.display = 'none';
                fileInfo.style.display = 'block';
                translateOptions.style.display = 'block';
                errorMsg.style.display = 'none';
                resultArea.style.display = 'none';

                // Hide preview if active
                container.classList.remove('has-preview');
                previewPane.style.display = 'none';
            }
        };

        removeFile.onclick = () => {
            selectedFile = null;
            fileUpload.value = '';
            fileInfo.style.display = 'none';
            translateOptions.style.display = 'none';
            dropArea.style.display = 'block';
            resultArea.style.display = 'none';
            container.classList.remove('has-preview');
            previewPane.style.display = 'none';
        };

        translateBtn.onclick = async () => {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('target_lang', targetLang.value);

            // UI Transitions
            translateOptions.style.display = 'none';
            fileInfo.style.display = 'none';
            statusMsg.style.display = 'block';
            errorMsg.style.display = 'none';

            try {
                const response = await fetch('/translate', {
                    method: 'POST',
                    body: formData
                });

                statusMsg.style.display = 'none';

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        lastResultFilename = data.preview_filename;
                        downloadLink.href = data.download_url;
                        resultArea.style.display = 'block';
                    } else {
                        errorMsg.innerHTML = `‚ùå <b>Translation Error:</b> ${data.error || 'Unknown failure'}`;
                        errorMsg.style.display = 'block';
                        fileInfo.style.display = 'block';
                        translateOptions.style.display = 'block';
                    }
                } else {
                    let errorText = 'Server Error';
                    try {
                        const data = await response.json();
                        errorText = data.error || errorText;
                    } catch (e) {
                        errorText = `${response.status} ${response.statusText}`;
                    }
                    errorMsg.innerHTML = `‚ùå <b>Network error:</b> ${errorText}<br><small style="opacity: 0.7">The server might be busy. Please try again or wait a moment.</small>`;
                    errorMsg.style.display = 'block';
                    fileInfo.style.display = 'block';
                    translateOptions.style.display = 'block';
                }
            } catch (error) {
                statusMsg.style.display = 'none';
                let diagnosticInfo = error.message || 'Check browser console';
                if (error.name === 'AbortError') diagnosticInfo = 'Request timed out';

                errorMsg.innerHTML = `‚ùå <b>Network error.</b> Please try again.<br><small style="opacity: 0.7">Details: ${diagnosticInfo}</small>`;
                errorMsg.style.display = 'block';
                fileInfo.style.display = 'block';
                translateOptions.style.display = 'block';
            }
        };

        // Preview Logic - Side Pane
        previewBtn.onclick = async () => {
            if (!lastResultFilename) return;

            previewBtn.textContent = '‚åõ Loading Preview...';
            previewBtn.disabled = true;

            try {
                const response = await fetch(`/get-preview/${lastResultFilename}`);
                const data = await response.json();

                if (data.success) {
                    previewTextArea.textContent = data.content;
                    container.classList.add('has-preview');
                    previewPane.style.display = 'flex';
                } else {
                    alert('Preview error: ' + data.error);
                }
            } catch (error) {
                alert('Connection error for preview');
            } finally {
                previewBtn.innerHTML = 'üëÅÔ∏è Preview Translated Text';
                previewBtn.disabled = false;
            }
        };
    });
</script>
{% endblock %}